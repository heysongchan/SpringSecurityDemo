<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>数据网格行编辑</title>
		<link rel="stylesheet" type="text/css" href="../../themes/default/easyui.css">
		<link rel="stylesheet" type="text/css" href="../../themes/icon.css">
		<link rel="stylesheet" type="text/css" href="../../demo.css">
		<script type="text/javascript" src="../../jquery.min.js"></script>
		<script type="text/javascript" src="../../jquery.easyui.min.js"></script>
	</head>
	<body>
	<div id='dg-row'></div>
	<input id="producttime"  name = "producttime" type='hidden'>
	<script>
		$(function(){
			$("#dg-row").datagrid({
				width:600,
				rownumbers:true,
				url:"http://127.0.0.1/easyui/example/c7/server/getProducts.php",
				loadMsg:"数据正在加载，请稍等",
				columns:[[
					    //产品名称在编辑模式时使用文本框标记
						{field:'productname' ,title:'产品名称',width:'10%',editor:"textbox"},
						//产品类型在编辑模式时使用组合框
						{field:'producttype',title:'产品类型',width:'10%',formatter:formatProductType,
							editor:{type:"combobox",options:{
								valueField:'id',
								textField:'typename',
								data:[
								      {id:1,typename:'电器'},
								      {id:2,typename:'食品'}
								]}}
						},
						//产品价格在编辑模式时使用数字框
						{field:'productprice' ,width:'20%',title:'产品价格',editor:
							{type:"numberbox",options:{
								required:true,
								min:0,
								precision:2,
								prefix:'$',
							}}
						},
						//产品上架时间在编辑模式时使用日期框
						{field:'producttime' ,title:'上架时间',width:'30%',formatter:formatProductTime,
							editor:{type:"datebox",options:{
								required:true,
								editable:false,
								parser: function(s){
									var t = Date.parse(s);
									if (!isNaN(t)){										
										return new Date(t);
									}else{
										return new Date();
									}
								},
								formatter:function(date){
									var y = date.getFullYear();
									var m = date.getMonth()+1;
									var d = date.getDate();
									return y+'/'+m+'/'+d+'/';
								},
								currentText:"今天",
								closeText:"关闭",
							}}
						},
						//产品产地在编辑模式时使用组合框
						{field:'productaddress' ,title:'产地',width:'20%',formatter:formatProductAddress,
							editor:{type:"combobox",options:{
								required:true,
								valueField:'id',
								textField:'city',
								data:[
								      {id:1,city:'北京'},
								      {id:2,city:'上海'},
								      {id:3,city:'南京'}
								]}}
						},
						//产品类型在编辑模式时使用数字微调器
						{field:'productvolume' ,title:'销售量',width:'10%',editor:
							{type:"numberspinner",options:{
								required:true,
								min:0,
							}}
						},
				]],			
				//工具栏中添加取消编辑的按钮
				toolbar:[{
					iconCls:'icon-cancel',
					handler:function(){
						//得到当前选中行对象
						var row=$("#dg-row").datagrid('getSelected');
						//获取当前选中行索引
						var index=$("#dg-row").datagrid('getRowIndex',row);
						//取消该行编辑
						$("#dg-row").datagrid('cancelEdit',index);
						//取消选中
						$("#dg-row").datagrid('unselectRow',index);
					}
				}],
				//双击事件
				onDblClickRow:function(index,row){
					//检查当前列是否在编辑模式下
					//如果在编辑模式下时将会结束编辑
					if(row.editing){
						//取消该行选中并结束编辑
						$(this).datagrid('unselectRow',index)
						.datagrid("endEdit",index);
					}else{
						//如果该行不在编辑模式时，选中该行并开启编辑模式
						//选中该行的目的是为了动态取消编辑时找到指定的行
						$(this).datagrid('selectRow',index)
						.datagrid("beginEdit",index);
					}				
				},
				//开始编辑前先标记该行已被编辑
				onBeforeEdit:function(index,row){
					row.editing=true;
				},
				//编辑完毕时标记该行未被编辑
				onAfterEdit:function(index,row){
					row.editing=false;
				},
				//取消编辑时标记该行未被编辑
				onCancelEdit:function(index,row){
					row.editing=false;
				},
				
			});
			
			//格式化上架时间
			function formatProductTime(value,row,index){
				var date=new Date(Date.parse(value));
				var Year=date.getFullYear();
				var Month=date.getMonth()+1;
				var Day=date.getDate();
				return  Year+"年"+Month+"月"+Day+"日";				
			}
			//格式化产地
			function formatProductAddress(value,row,index){
				switch(value){
					case "1":
						return  "北京";
					case "2":
						return "上海";
					case "3":
						return  "南京";
					default:
						return value;
				}
			}
			//格式化产品类型
			function formatProductType(value,row,index){
				if(value == "1"){
					return "电器";
				}else if(value == "2"){
					return "食品";
				}else{
					return value;
				}
			}
		})
	</script>
	</body>
</html>

